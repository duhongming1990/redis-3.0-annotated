# 9 数据库

## 9.1 服务器中的数据库
redis.h/redisServer
```cfml
struct redisServer {
    // 数据库
    redisDb *db;
    int dbnum; /* Total number of configured DBs */
}
```
可以在配置文件中配置：databases 16

## 9.2 切换数据库
redis.h/redisClient
```cfml
typedef struct redisClient {
    // 当前正在使用的数据库
    redisDb *db;
    // 当前正在使用的数据库的 id （号码）
    int dictid;
}
```
命令：
    
    SELECT <dbid>

## 9.3 数据库键空间(key space)
redis.h/redisDb
```cfml
typedef struct redisDb {
    // 数据库键空间，保存着数据库中的所有键值对
    dict *dict;  /* The keyspace for this DB */
```
## 9.4 设置键的生存时间（time to live，TTL）或过期时间

### 9.4.1 设置过期时间
    EXPIRE key ttl
    PEXPIRE key ttl
    EXPIREAT key timestamp
    PEXPIREAT key timestamp（最终执行的命令）
    
### 9.4.2 保存过期时间
redis.h/redisDb
```cfml
typedef struct redisDb {
    // 键的过期时间，字典的键为键，字典的值为过期事件 UNIX 时间戳
    dict *expires; 
}
```

### 9.4.3 移除过期时间
    PERSIST key

### 9.4.4 计算并返回剩余生存时间
    TTL key
    PTTL key
    
### 9.4.5 过期键的判定
1. 检查给定键是否在过期字典中：存在，则获取。
2. 检查当前的UNIX时间戳与键的过期时间。

## 9.5 过期键删除策略
    定时删除：不现实
    惰性删除：expireIfNeeded函数实现
    定期删除：activeExpireCycle函数实现

## 9.6 AOF、RDB和复制功能对过期键的处理
    执行SAVE、BGSAVE生成RDB文件和执行BGREWRITEAOF生成的AOF不会包含过期键
    主服务器删除一个过期键之后，会向所有从服务器发送一条DEL命令，从服务器即使发现过期键也不会自作主张地删除它。
    
# 10 RDB持久化

## 10.1 RDB文件的创建于载入
    SAVE阻塞Redis服务器进程
    BGSAVE会派生出一个子进程，Redis父进程继续处理命令请求
    AOF开启的话，优先使用
    
## 10.2 自动间隔性保存

### 10.2.1 设置保存条件
```
#   In the example below the behaviour will be to save:
#   after 900 sec (15 min) if at least 1 key changed
#   after 300 sec (5 min) if at least 10 keys changed
#   after 60 sec if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000
```

redis.h/redisServer
```cfml

struct redisServer {
    struct saveparam *saveparams;   /* Save points array for RDB */
    int saveparamslen;              /* Number of saving points */
}

// 服务器的保存条件（BGSAVE 自动执行的条件）
struct saveparam {

    // 多少秒之内
    time_t seconds;

    // 发生多少次修改
    int changes;

};

```

### 10.2.2 dirty计数器和lastsave属性
```cfml
struct redisServer {
    // 自从上次 SAVE 执行以来，数据库被修改的次数
    long long dirty;                /* Changes to DB from the last save */

    // BGSAVE 执行前的数据库被修改次数
    long long dirty_before_bgsave;  /* Used to restore dirty on failed BGSAVE */
}
```

### 10.2.3 检查保存条件是否满足

## 10.3 RDB文件结构
    REDIS | db_version | databasees | EOF | check_sums
## 10.4 分析RDB文件
    redis-check-dump 或者 od -cx dump.rdb

# 11 AOF（Append Only File）持久化

# 12 事件
